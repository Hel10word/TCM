## MySQL

MySQL加速导入数据

https://cs.xieyonghui.com/database/mysql-import-performance_68.html



#### mysqldump

https://www.cnblogs.com/billyxp/p/3486672.html

https://github.com/yashsmehta/mysqldump-to-csv

https://www.cnblogs.com/ding2016/p/9548528.html

#### select into outfile

[参考stackoverflow](https://stackoverflow.com/questions/2804332/mysql-select-into-outfile-to-a-different-server)

```sql
-- 先查看 支持导入的目录
show variables like '%secure%';

-- 数据只会导出到服务端
(select *
from test_db.lineitem_mysql)
into outfile '/usr/local/test1.csv'
FIELDS
-- 每个字段用什么符号包裹  默认 没有
ENCLOSED BY '-'
-- 每个字段 之间的建个符号 默认为 \t
TERMINATED BY ','
-- 使用的 转义字符        默认为 \
ESCAPED BY '\\'
-- 每行数据的分隔符		  默认为 \n
LINES TERMINATED BY '\n';
```

#### Load Data

https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_local_infile

```sh
mysql -h 192.168.30.200 -P 3306 -uroot -proot --database test_db --local-infile=ON -e "load data local infile '/usr/local/lineitem.csv' into table lineitem fields terminated by ',' lines terminated by '\n';"
```



#### 优化参考

```sql
-- https://blog.csdn.net/dvd_sun/article/details/87778577
-- https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html


set GLOBAL innodb_flush_log_at_trx_commit=0

set GLOBAL sync_binlog=0


------------------Robert 提醒



-- 修改MySQL的事务管理参数，在完成加载后参数应该复原原来参数值
set autocommit = 0;
-- https://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_autocommit
-- 查看当前会话 ID
-- select connection_id() 
-- show variables like 'autocommit';

1 == ON  0 == OFF

set unique_checks = 0;
set unique_checks = 0;
set sql_log_bin=0;

-- 临时禁止在一张表上的所有约束
alter table lineitem disable keys;

-- global settings that should be set in my.cnf
flush_time = 300    -- effective value to Windows whose default is 0
-- following variables have default value 4
innodb_read_io_threads = 8
-- 4

innodb_write_io_threads = 8
-- 4

innodb_buffer_pool_size = 1G
-- 134217728

innodb_log_file_size = 100M
-- 50331648

innodb_log_buffer_size = 64M
-- 16777216

-- show variables where Variable_name in ('autocommit','unique_checks','foreign_key_checks','sql_log_bin','innodb_read_io_threads','innodb_write_io_threads','innodb_buffer_pool_size','innodb_log_file_size','innodb_log_buffer_size');




innodb_autoextend_increment 表空间自增值

innodb_log_buffer_size log缓存区大小

innodb_log_file_size binlog文件大小

bulk_insert_buffer_size 批量写入的数据大小
```

#### 分割文件方式

>   把数据文件等分6份，每个子文件有100万行，总共7个文件。简单在命令行同时跑加载跑两次，一次26秒完成，另外一次30秒完成。环境是LXC容器。




```sh
# 导出六个 CSV
-- SELECT * FROM `lineitem_mysql` LIMIT 1 OFFSET 1;
## for i in {0..5}; do a=$[10000*100];b=$[i*a]; echo "${a} ${b}"; done

for i in {0..5}; do a=$[10000*100];b=$[i*a]; psql postgres://postgres:postgres@192.168.30.155/test_db -c "\copy (select * from lineitem_sf1_pgsql limit $a offset $b) to '/usr/local/lineitem_600w_$i.csv' with DELIMITER ',';"; done
```

 





## MemSQL

​	MemSQL 默认是行存储，并且表数据存储在内存中，虽然 MemSQL 可以搭建集群，但是单表还是存储在单节点上。可以通过建表语句来指定为[列存储](https://docs.singlestore.com/db/v7.8/en/create-your-database/physical-database-schema-design/concepts-of-physical-database-schema-design/columnstore.html)，表数据存储在磁盘中。

```sql
-- 行存储
CREATE TABLE lineitem(
  l_orderkey INT not NULL
,l_partkey INT not NULL
,l_suppkey INT not NULL
,l_linenumber INT not NULL
,l_quantity DECIMAL(15,2) not NULL
,l_extendedprice DECIMAL(15,2) not NULL
,l_discount DECIMAL(15,2) not NULL
,l_tax DECIMAL(15,2) not NULL
,l_returnflag VARCHAR(1) not NULL
,l_linestatus VARCHAR(1) not NULL
,l_shipdate DATE not NULL
,l_commitdate DATE not NULL
,l_receiptdate DATE not NULL
,l_shipinstruct VARCHAR(25) not NULL
,l_shipmode VARCHAR(10) not NULL
,l_comment VARCHAR(44) not NULL
);

-- 列存储
CREATE TABLE lineitem (
  l_orderkey INT not NULL
,l_partkey INT not NULL
,l_suppkey INT not NULL
,l_linenumber INT not NULL
,l_quantity DECIMAL(15,2) not NULL
,l_extendedprice DECIMAL(15,2) not NULL
,l_discount DECIMAL(15,2) not NULL
,l_tax DECIMAL(15,2) not NULL
,l_returnflag VARCHAR(1) not NULL
,l_linestatus VARCHAR(1) not NULL
,l_shipdate DATE not NULL
,l_commitdate DATE not NULL
,l_receiptdate DATE not NULL
,l_shipinstruct VARCHAR(25) not NULL
,l_shipmode VARCHAR(10) not NULL
,l_comment VARCHAR(44) not NULL
,UNIQUE KEY pk (l_orderkey, l_linenumber) UNENFORCED RELY
,SHARD KEY (l_orderkey) USING CLUSTERED COLUMNSTORE
);
```

​	由于 MemSQL 表数据默认存储在内存中，可能实际 8GB 的数据，由于各个维护字段等加起来占用内存能达到 12GB 甚至更多。单表默认存储上限是该节点实际可用内存的 80%，因此可以通过一下语句来修改节点上的表存储限制。

```sql
-- 修改当前库的最大容量
select @@global.maximum_memory
set @@global.maximum_memory=19924;

-- 修改当前表的最大容量
select @@global.maximum_table_memory
set @@global.maximum_table_memory=18924;
```

​	由于 MemSQL 默认会通过 Log 来记录各个数据的变更，因此可以使用如下语句来手动设置相关文件的存储大小

```sql

select @@GLOBAL.log_file_size_partitions
set @@GLOBAL.log_file_size_partitions=10485760 

select @@GLOBAL.log_file_size_ref_dbs
set @@GLOBAL.log_file_size_ref_dbs=

select @@GLOBAL.snapshot_trigger_size 
set @@GLOBAL.snapshot_trigger_size=536870912

-- https://docs.singlestore.com/db/v7.8/en/user-and-cluster-administration/high-availability-and-disaster-recovery/transaction-logs-snapshots/manage-disk-space.html
select @@GLOBAL.snapshots_to_keep
set @@GLOBAL.snapshots_to_keep=1
```

