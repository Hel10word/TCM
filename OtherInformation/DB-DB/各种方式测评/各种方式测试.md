

## PgSQL

### Shell 方式

PgSQL所支持的导出数据语法，同样 PgSQL 也有自己的导出工具 [pgdump][PgSQL-pgdump] 可以通过 `pg_dump -h 192.168.30.31 -p 5432 -U postgres -t lineitem test_db > /usr/local/lineitem1.sql` 语句来导出表数据，但是会附带表结构等信息，因此我们默认使用 Copy 语句来导出为文本文件。

[PgSQL-Copy-DDL][PgSQL-Copy-DDL]


#### 导出
本地生成 Shell Script，然后使用 Java 程序去执行本地脚本文件，主要的语句如下
```sh
# Posql-Export.sh

psql postgres://postgres:123456@192.168.30.155:5432/test_db -c "\copy lineitem to '/usr/local/lineitem.csv' with DELIMITER ',';"
```

#### 导入

本地生成 Shell Script，然后使用 Java 程序去执行本地脚本，主要语句如下


```sh
# Posql-Load.sh

psql postgres://postgres:123456@192.168.30.155:5432/test_db -c "\copy lineitem from '/usr/local/lineitem.csv' with DELIMITER ',';"
```



### JDBC 方式

主要依赖 JDBC 的 CopyManager 类，该类是 PgSQL JDBC 独有的类，主要实现也是依赖 Copy 语句。

[PgSQL-JDBC-CopyManager][PgSQL-JDBC-CopyManager]


#### 导出

```java
String url = "jdbc:postgresql://192.168.30.155:5432/test_db";
Properties properties = new Properties();
properties.put("user","postgres");
properties.put("password","123456");
Driver driver = (Driver) Class.forName("org.postgresql.Driver").newInstance();
try(
    Connection conn = driver.connect(url,properties);
    FileOutputStream file = new FileOutputStream("/usr/local/lineitem.csv")
){
    CopyManager copyManager = new CopyManager((BaseConnection) conn);
    long l = copyManager.copyOut("COPY lineitem TO STDIN WITH DELIMITER ','", file);
    return l;
} catch (SQLException | IOException e) {
    e.printStackTrace();
}
```


#### 导入

```java
String url = "jdbc:postgresql://192.168.30.155:5432/test_db";
Properties properties = new Properties();
properties.put("user","postgres");
properties.put("password","123456");
Driver driver = (Driver) Class.forName("org.postgresql.Driver").newInstance();
try(
    Connection conn = driver.connect(url,properties);
    FileOutputStream file = new FileOutputStream("/usr/local/lineitem.csv")
){
    CopyManager copyManager = new CopyManager((BaseConnection) conn);
    long l = copyManager.copyIn("COPY lineitem FROM STDIN WITH DELIMITER ','", file);
    return l;
} catch (SQLException | IOException e) {
    e.printStackTrace();
}
```






---

- **OS** CentOS Linux release 7.9.2009 (Core)
- **Kernel** Linux version 3.10.0-1160.15.2.el7.x86_64
- **java** version "1.8.0_171"
- **PostgreSQL** 13.6 on x86_64-pc-linux-gnu, 
- **CPU** Intel(R) Xeon(R) Silver 4210 CPU @ 2.20GHz * 8
- **Memory** 8GB
- **Network** 全程 BUTP 平台 30 网段



|            | Sf10 本地           | sf10 远程          |
| ---------- | ------------------- | ------------------ |
| JDBC  导出 | 2 m 50 s （170 s）  | 2 m 36 s （156 s） |
| Shell 导出 | 2 m 30 s （160 s）  | 2 m 24 s （145 s） |
| JDBC  导入 | 5 m 50 s （350 s）  | 5 m 55 s （355 s） |
| Shell 导入 | 6 m 5 s   （365 s） | 6 m 10 s （370 s） |



[PgSQL-pgdump]:https://www.postgresql.org/docs/13/app-pgdump.html

[PgSQL-Copy-DDL]:https://www.postgresql.org/docs/13/sql-copy.html

[PgSQL-JDBC-CopyManager]:https://jdbc.postgresql.org/documentation/publicapi/org/postgresql/copy/CopyManager.html





---





## MySQL

### Shell 方式

由于 MySQL 本身并没有很好的支持 CSV 文件的远程导出，以下是我收集到的基于 MySQL 本身数据导入导出的方案。

#### 导出

##### 1、使用 Select \* | sed > file.csv ，将查询结果存在内存，并用 sed 来格式化

主要是通过查询语句，将想要的结果查询到内存中，然后使用 Linux 的 sed 命令来将其格式化为 CSV 文件并保存。

-   由于要将全量的表数据通过查询，存在内存中，对于数据量大于机器内存的表，无法完成此操作。
-   使用 sed 命令格式化复杂的数据，差错比较大。

[mysql -sN][mysql -sN] 、[sed][sed]

```sh
# shell-export.sh

time mysql -h 192.168.30.38 -P 3306 -uroot -proot --database test_db -sN -e "select * from lineitem" | sed 's/"/""/g;s/\t/,/g;s/\n//g' > ./lineitem.csv
```



##### 2、使用 Select into file 导出到服务端本地，然后用 SCP 等命令发送到客户端

该命令只支持导出到服务端本地，无法导出到客户端，并且导出的目录受限于 [secure_file_priv][secure_file_priv] 配置，因此只能尝试将数据导出到本地后，再通过 SCP 等命令网络传输到客户端。

-   因为 **sercure_file_priv** 配置是只读的，需要修改配置文件，因此需要重启 MySQL 服务。
-   SCP 等命令，会被网络影响较大，而且需要有用 SSH 用户的权限。

[select into outfile][select into outfile]

```sh
# shell-export.sh

mysql -h 192.168.30.38 -P 3306 -uroot -proot --database test_db -e "(select *
from lineitem) into outfile '/var/lib/mysql-files/lineitem.csv' FIELDS ENCLOSED BY '-' TERMINATED BY ',' ESCAPED BY '\\' LINES TERMINATED BY '\n';"

scp root@192.168.30.38:var/lib/mysql-files/lineitem.csv ./
```



##### 3、使用 mysqldump 命令

该命令默认会以 `Insert` 语句的方式导出数据，通过更改默认参数，会再指定目录下生成两个文件，一个包含 `Create Table` 建表语句的 `.sql` 文件，以及一个 `.txt` 记录表数据的文件，可以通过相关的配置，使其符合 CSV 的文件格式。

-    `Insert` 格式的数据，可以导出到客户端，但是这种格式不利于导入到其他数据源。
-   使用 -T 命令，导出符合 CSV 格式的数据文件，本质还是依赖 `Select into outfile` ，因此依然受限于 **sercure_file_priv** 配置，而且客户端只会保留建表的 `.sql` 文件，`.txt` 格式的数据文件依然存放于服务端。

[mysqldump][mysqldump]

```sh
# shell-export.sh

mysqldump -h 192.168.30.38 -P 3306 -uroot -proot -T /var/lib/mysql-files/ test_db lineitem --fields-terminated-by=',' --fields-enclosed-by='\"'
```



#### 导入

MySQL 可以通过 `Load data` 的语法来高效的导入文本文件，其语法与  `Select into outfile` 相似，并且可以添加 **local** 关键字来导入客户端文件。

[load-data][load-data]

```sh
# shell-load.sh

mysql -h 192.168.30.38 -P 3306 -uroot -proot --database test_db -e "load data local infile '/usr/local/lineitem.csv' into table lineitem fields terminated by ',' lines terminated by '\n';"
```



### MySQL-Shell 方式

MySQL-Shell在 8.0.22 发布的版本（2020-10-19）版本中 加入了 **util.exportTable()** 与 **util.importTable()** 工具包。

#### 导出

[MySQL-Shell-Export][MySQL-Shell-Export]

```sh
# mysql-shell-export.sh

mysqlsh -h192.168.30.38 -P3306 -uroot -proot --database test_db -e "util.exportTable('lineitem','/usr/local/lineitem.csv',{linesTerminatedBy:'\n',fieldsTerminatedBy:','})"
```



#### 导入

​	根据官方介绍可知道，该函数底层与 Load Data 相同，虽然可以多线程的并发导入，但是 MySQL 5.7 依然是单线程的将数据写入到表中，在后续的测试用，发现其性能还不如直接使用 Load Data 语句。

[MySQL-Shell-Load][MySQL-Shell-Load]

```sh
# mysql-shell-load.sh

mysqlsh -h192.168.30.38 -P3306 -uroot -proot --database test_db -e "util.importTable('/usr/local/lineitem.csv', {table: 'lineitem',linesTerminatedBy:'\n',fieldsTerminatedBy:',',bytesPerChunk:'500M'})"
```



### JDBC 方式

#### 导出

与 Shell 方式一样，使用 Select into outfile 导出的 CSV 文件依然存在于 MySQL 服务端。

#### 导入

使用 JDBC 的方案，执行 Load Data 效率要比 Shell 调用高。







---



[mysql -sN]:https://dev.mysql.com/doc/refman/5.7/en/mysql-command-options.html#option_mysql_skip-column-names

[sed]:https://www.gnu.org/software/sed/manual/sed.html#sed-commands-list

[select into outfile]:https://dev.mysql.com/doc/refman/5.7/en/select-into.html

[secure_file_priv]:https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_secure_file_priv

[mysqldump]:https://dev.mysql.com/doc/refman/5.7/en/mysqldump.html

[load-data]:https://dev.mysql.com/doc/refman/5.7/en/load-data.html
[MySQL-Shell-Export]:https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-utilities-table-export.html
[MySQL-Shell-Load]:https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-utilities-parallel-table.html







---



## 其他产品



https://blog.csdn.net/inrgihc/article/details/114000246